<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Tahoma, sans-serif; background: #f4f7f6; padding: 10px; direction: rtl; }
        .card { background: white; padding: 15px; border-radius: 12px; border: 1px solid #ddd; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .header { text-align: center; color: #2c3e50; border-bottom: 2px solid #3498db; margin-bottom: 15px; padding-bottom: 10px; }
        input { padding: 12px; width: 65%; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px; }
        button { padding: 10px 15px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin: 2px; transition: 0.3s; }
        .btn-p { background: #27ae60; color: white; }
        .btn-s { background: #2980b9; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #333; padding: 10px; text-align: center; vertical-align: top; }
        th { background: #34495e; color: white; }
        .log-box { text-align: right; font-size: 11px; white-space: pre-wrap; line-height: 1.6; min-height: 50px; cursor: pointer; background: #fffdf0; padding: 5px; }
        .date-tag { color: #d35400; font-weight: bold; font-size: 10px; display: block; background: #eee; padding: 2px; margin-bottom: 4px; }
        .controls { margin-top: 20px; display: flex; gap: 10px; }
        .edit-btn { font-size: 10px; background: #f39c12; color: white; padding: 4px; margin-top: 5px; width: 100%; }
    </style>
</head>
<body>

<div class="card">
    <div class="header"><h2>ğŸ“‹ Ù…Ø¯ÛŒØ±ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ú©Ø§Ø±Ú¯Ø§Ù‡</h2></div>
    
    <input type="text" id="p_in" placeholder="Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ (Ù…Ø«Ù„Ø§Ù‹: Ù¾Ø±ÙˆÚ˜Ù‡ ÙÙˆÙ„Ø§Ø¯)">
    <button class="btn-p" onclick="addP()">+ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯</button>
    <br>
    <input type="text" id="s_in" placeholder="Ù†Ø§Ù… Ù…Ø±Ø­Ù„Ù‡ (Ù…Ø«Ù„Ø§Ù‹: Ø¬ÙˆØ´Ú©Ø§Ø±ÛŒ)">
    <button class="btn-s" onclick="addS()">+ Ù…Ø±Ø­Ù„Ù‡ Ø¬Ø¯ÛŒØ¯</button>

    <div style="overflow-x: auto;">
        <table id="mainTable">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>

    <div class="controls">
        <button onclick="exportData()" style="flex: 1; background:#8e44ad; color:white;">ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
        <button onclick="document.getElementById('fileIn').click()" style="flex: 1; background:#c0392b; color:white;">ğŸ“¥ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ (Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ)</button>
        <input type="file" id="fileIn" style="display:none" onchange="importData(event)">
    </div>
</div>

<script>
    // Ø­Ø§ÙØ¸Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ¯Ø§Ø®Ù„
    var prjs = JSON.parse(localStorage.getItem('WORKSHOP_V20_DATA')) || [];
    var stps = JSON.parse(localStorage.getItem('WORKSHOP_V20_STEPS')) || [];

    function refresh() {
        localStorage.setItem('WORKSHOP_V20_DATA', JSON.stringify(prjs));
        localStorage.setItem('WORKSHOP_V20_STEPS', JSON.stringify(stps));

        var h = document.getElementById('thead');
        var hHtml = '<tr><th>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±ÙˆÚ˜Ù‡</th>';
        for(var i=0; i<stps.length; i++) {
            hHtml += '<th>' + stps[i] + ' <br><button onclick="delS('+i+')" style="background:none;color:red;font-size:9px">Ø­Ø°Ù</button></th>';
        }
        h.innerHTML = hHtml + '</tr>';

        var b = document.getElementById('tbody');
        var bHtml = '';
        for(var j=0; j<prjs.length; j++) {
            bHtml += '<tr>';
            bHtml += '<td><b style="font-size:14px">' + prjs[j].n + '</b><button class="edit-btn" onclick="editPName('+j+')">ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ø§Ù…</button><button class="edit-btn" style="background:#e74c3c" onclick="delP('+j+')">Ø­Ø°Ù Ù¾Ø±ÙˆÚ˜Ù‡</button></td>';
            for(var k=0; k<stps.length; k++) {
                var content = prjs[j].c[k] || "Ø¨Ø¯ÙˆÙ† ÛŒØ§Ø¯Ø¯Ø§Ø´Øª";
                bHtml += '<td><div class="log-box" onclick="editLog('+j+','+k+')">' + content + '</div></td>';
            }
            bHtml += '</tr>';
        }
        b.innerHTML = bHtml;
    }

    function addP() {
        var v = document.getElementById('p_in').value;
        if(v.trim()) { prjs.push({ n: v, c: {} }); document.getElementById('p_in').value = ""; refresh(); }
    }

    function addS() {
        var v = document.getElementById('s_in').value;
        if(v.trim()) { stps.push(v); document.getElementById('s_in').value = ""; refresh(); }
    }

    function editPName(i) {
        var n = prompt("ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡:", prjs[i].n);
        if(n) { prjs[i].n = n; refresh(); }
    }

    function editLog(pIdx, sIdx) {
        // Ø¨Ø±Ø§ÛŒ Ø§Ø¯ÛŒØªØŒ Ù…Ø­ØªÙˆØ§ÛŒ ÙØ¹Ù„ÛŒ Ø±Ø§ Ø¯Ø± Prompt Ù…ÛŒâ€ŒØ¢ÙˆØ±ÛŒÙ… (ØªÚ¯â€ŒÙ‡Ø§ÛŒ HTML Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø±Ø§Ø­Øªâ€ŒØªØ±)
        var current = prjs[pIdx].c[sIdx] || "";
        var cleanText = current.replace(/<[^>]*>/g, "\n").replace(/\n\n/g, "\n").trim();
        
        var msg = prompt("ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ ÛŒØ§ Ù‚Ø¨Ù„ÛŒ Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯:\n(Ø®Ø§Ù„ÛŒ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯ ØªØ§ Ù¾Ø§Ú© Ø´ÙˆØ¯)", cleanText);
        
        if(msg !== null) {
            if(msg.trim() === "") {
                prjs[pIdx].c[sIdx] = "";
            } else {
                var now = new Date();
                var d = now.toLocaleDateString('fa-IR') + " " + now.getHours() + ":" + (now.getMinutes()<10?'0':'') + now.getMinutes();
                var entry = '<span class="date-tag">' + d + '</span>' + msg.replace(/\n/g, "<br>") + '<hr>';
                
                // Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ù‚Ø¨Ù„ÛŒ Ø¨Ù…Ø§Ù†Ø¯ Ùˆ Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø¢Ù† Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯:
                prjs[pIdx].c[sIdx] = entry + (prjs[pIdx].c[sIdx] || "");
            }
            refresh();
        }
    }

    function delP(i) { if(confirm("Ù¾Ø±ÙˆÚ˜Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) { prjs.splice(i, 1); refresh(); } }
    function delS(i) { if(confirm("Ù…Ø±Ø­Ù„Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) { stps.splice(i, 1); refresh(); refresh(); } }

    function exportData() {
        var data = JSON.stringify({ p: prjs, s: stps });
        var blob = new Blob([data], { type: 'application/json' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "workshop_backup.json";
        a.click();
    }

    function importData(event) {
        var reader = new FileReader();
        reader.onload = function(e) {
            var data = JSON.parse(e.target.result);
            if(data.p && data.s) { prjs = data.p; stps = data.s; refresh(); alert("Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯."); }
        };
        reader.readAsText(event.target.files[0]);
    }

    refresh();
</script>
</body>
</html>
