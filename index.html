<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>مدیریت تولید</title>
    <style>
        body { font-family: Tahoma; background: #eee; padding: 10px; }
        table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 10px; }
        th, td { border: 1px solid #000; padding: 10px; text-align: center; }
        .done { background: #90ee90; } /* سبز برای تمام شده */
        #box { display: none; position: fixed; top: 10%; background: #fff; padding: 20px; border: 3px solid #000; width: 80%; right: 5%; }
    </style>
</head>
<body>

    <div style="background:#fff; padding:10px; border-radius:10px;">
        <input type="text" id="p_in" placeholder="نام پروژه">
        <button onclick="addP()">+ پروژه</button>
        <hr>
        <input type="text" id="s_in" placeholder="نام مرحله">
        <button onclick="addS()">+ مرحله</button>
    </div>

    <table id="table">
        <thead id="head"></thead>
        <tbody id="body"></tbody>
    </table>

    <div id="box">
        <h3 id="btitle"></h3>
        <textarea id="btxt" style="width:100%; height:80px;" placeholder="یادداشت جدید..."></textarea><br><br>
        <button style="background:green; color:#fff;" onclick="save()">ثبت با ساعت و تاریخ</button>
        <button style="background:orange;" onclick="finS()">اتمام این مرحله</button>
        <button onclick="document.getElementById('box').style.display='none'">بستن</button>
    </div>

<script>
    var STEPS = JSON.parse(localStorage.getItem('ST_1')) || [];
    var PROJS = JSON.parse(localStorage.getItem('PR_1')) || [];
    var curP, curS;

    function render() {
        localStorage.setItem('ST_1', JSON.stringify(STEPS));
        localStorage.setItem('PR_1', JSON.stringify(PROJS));

        var h = document.getElementById('head');
        h.innerHTML = '<tr><th>پروژه</th>' + STEPS.map((s, i) => '<th>' + s + ' <br><button onclick="delS('+i+')">حذف</button></th>').join('') + '</tr>';

        var b = document.getElementById('body');
        b.innerHTML = '';
        PROJS.forEach((p, pi) => {
            var row = '<tr style="'+(p.f?'background:#d1ffd1':'')+'"><td><b>'+p.n+'</b><br><button onclick="finP('+pi+')">تمام/ادامه</button><br><button onclick="delP('+pi+')">حذف</button></td>';
            STEPS.forEach((s, si) => {
                var d = p.d[si] || {t:'', f:false};
                var cls = d.f ? 'done' : '';
                row += '<td class="'+cls+'" onclick="openB('+pi+','+si+')">' + (d.f?'[تمام] ':'') + d.t.replace(/\n/g, '<br>') + '</td>';
            });
            row += '</tr>';
            b.innerHTML += row;
        });
    }

    function addP() { var v = document.getElementById('p_in').value; if(v){ PROJS.push({n:v, d:{}, f:false}); document.getElementById('p_in').value=''; render(); } }
    function addS() { var v = document.getElementById('s_in').value; if(v){ STEPS.push(v); document.getElementById('s_in').value=''; render(); } }
    function delP(i) { if(confirm('حذف؟')) { PROJS.splice(i,1); render(); } }
    function delS(i) { if(confirm('حذف؟')) { STEPS.splice(i,1); render(); } }
    function finP(i) { PROJS[i].f = !PROJS[i].f; render(); }

    function openB(pi, si) {
        curP = pi; curS = si;
        document.getElementById('btitle').innerText = PROJS[pi].n + ' > ' + STEPS[si];
        document.getElementById('btxt').value = '';
        document.getElementById('box').style.display = 'block';
    }

    function save() {
        var txt = document.getElementById('btxt').value;
        if(!txt) return;
        if(!PROJS[curP].d[curS]) PROJS[curP].d[curS] = {t:'', f:false};
        var now = new Date();
        var time = now.toLocaleDateString('fa-IR') + ' (' + now.getHours() + ':' + now.getMinutes() + ')';
        PROJS[curP].d[curS].t = time + ': ' + txt + '\n' + PROJS[curP].d[curS].t;
        document.getElementById('box').style.display = 'none';
        render();
    }

    function finS() {
        if(!PROJS[curP].d[curS]) PROJS[curP].d[curS] = {t:'', f:false};
        PROJS[curP].d[curS].f = !PROJS[curP].d[curS].f;
        document.getElementById('box').style.display = 'none';
        render();
    }

    render();
</script>
</body>
</html>
