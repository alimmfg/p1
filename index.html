<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ú¯Ø§Ù‡</title>
<style>
body{
    font-family:Tahoma;
    background:#f2f2f2;
    padding:15px;
    font-size:16px;
}
button{
    padding:8px 12px;
    margin:4px;
    font-size:15px;
    cursor:pointer;
}
.project{
    background:white;
    border-radius:10px;
    padding:12px;
    margin-bottom:15px;
    border:1px solid #ccc;
}
.project-title{
    font-size:20px;
    font-weight:bold;
    cursor:pointer;
}
.step{
    border:1px solid #ddd;
    border-radius:8px;
    padding:8px;
    margin-top:10px;
}
.step-title{
    font-size:17px;
    font-weight:bold;
    cursor:pointer;
}
.log{
    background:#eee;
    padding:8px;
    border-radius:6px;
    margin-top:6px;
    cursor:pointer;
    font-size:14px;
}
.log-date{
    font-size:12px;
    color:#555;
    margin-bottom:4px;
}
.done{
    opacity:0.5;
    text-decoration:line-through;
}

/* Ù…ÙˆØ¯Ø§Ù„ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª */
#modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.5);
    z-index:999;
    align-items:center;
    justify-content:center;
}
#modalBox{
    background:white;
    padding:15px;
    width:90%;
    max-width:450px;
    border-radius:10px;
}
textarea{
    width:100%;
    font-family:Tahoma;
    font-size:15px;
}
</style>
</head>

<body>

<button onclick="addProject()">â• Ù¾Ø±ÙˆÚ˜Ù‡</button>
<button onclick="backup()">ğŸ’¾ Ø¨Ú©â€ŒØ¢Ù¾</button>
<button onclick="document.getElementById('file').click()">ğŸ“¥ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ú©â€ŒØ¢Ù¾</button>
<input type="file" id="file" style="display:none" onchange="restore(event)">

<div id="app"></div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª -->
<div id="modal">
<div id="modalBox">
<h3>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</h3>
<textarea id="logText" rows="6"></textarea><br><br>
<button onclick="saveLog()">Ø«Ø¨Øª</button>
<button onclick="closeModal()">Ø§Ù†ØµØ±Ø§Ù</button>
</div>
</div>

<script>
let data = JSON.parse(localStorage.getItem("WORKSHOP_DATA")) || [];
let curP=null, curS=null, curL=null;

function saveLocal(){
    localStorage.setItem("WORKSHOP_DATA", JSON.stringify(data));
}

function addProject(){
    let n = prompt("Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡:");
    if(!n) return;
    data.push({n,steps:[],done:false,cell:{}});
    saveLocal(); render();
}

function render(){
    let app=document.getElementById("app");
    app.innerHTML="";
    data.forEach((p,pi)=>{
        let pd=document.createElement("div");
        pd.className="project"+(p.done?" done":"");
        pd.innerHTML=`
            <div class="project-title" onclick="editProject(${pi})">${p.n}</div>
            <button onclick="addStep(${pi})">â• Ù…Ø±Ø­Ù„Ù‡</button>
            <button onclick="finishProject(${pi})">Ø§ØªÙ…Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡</button>
        `;
        p.steps.forEach((s,si)=>{
            let sd=document.createElement("div");
            let finished = p.cell[si]?.done;
            sd.className="step"+(finished?" done":"");
            sd.innerHTML=`
                <div class="step-title" onclick="editStep(${pi},${si})">${s}</div>
                <button onclick="openLog(${pi},${si})">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</button>
                <button onclick="finishStep(${pi},${si})">Ø§ØªÙ…Ø§Ù… Ù…Ø±Ø­Ù„Ù‡</button>
            `;
            (p.cell[si]?.logs||[]).forEach((l,li)=>{
                let ld=document.createElement("div");
                ld.className="log";
                ld.innerHTML=`
                    <div class="log-date">${l.d}</div>
                    ${l.t.replace(/\n/g,"<br>")}
                `;
                ld.onclick=()=>editLog(pi,si,li);
                sd.appendChild(ld);
            });
            pd.appendChild(sd);
        });
        app.appendChild(pd);
    });
}

function editProject(i){
    let n=prompt("ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡:",data[i].n);
    if(n){ data[i].n=n; saveLocal(); render(); }
}

function addStep(i){
    let n=prompt("Ù†Ø§Ù… Ù…Ø±Ø­Ù„Ù‡:");
    if(!n) return;
    data[i].steps.push(n);
    saveLocal(); render();
}

function editStep(pi,si){
    let n=prompt("ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ø§Ù… Ù…Ø±Ø­Ù„Ù‡:",data[pi].steps[si]);
    if(n){ data[pi].steps[si]=n; saveLocal(); render(); }
}

function finishProject(i){
    data[i].done=true;
    saveLocal(); render();
}

function finishStep(pi,si){
    if(!data[pi].cell[si]) data[pi].cell[si]={logs:[],done:false};
    data[pi].cell[si].done=true;
    saveLocal(); render();
}

function openLog(pi,si){
    curP=pi; curS=si; curL=null;
    document.getElementById("logText").value="";
    document.getElementById("modal").style.display="flex";
}

function editLog(pi,si,li){
    curP=pi; curS=si; curL=li;
    document.getElementById("logText").value=data[pi].cell[si].logs[li].t;
    document.getElementById("modal").style.display="flex";
}

function saveLog(){
    let t=document.getElementById("logText").value;
    if(!t.trim()) return;
    if(!data[curP].cell[curS]) data[curP].cell[curS]={logs:[],done:false};
    let now=new Date().toLocaleString("fa-IR");
    if(curL!=null){
        data[curP].cell[curS].logs[curL].t=t;
    }else{
        data[curP].cell[curS].logs.unshift({t,d:now});
    }
    saveLocal();
    closeModal(); render();
}

function closeModal(){
    document.getElementById("modal").style.display="none";
}

function backup(){
    let blob=new Blob([JSON.stringify(data)],{type:"application/json"});
    let a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="workshop-backup.json";
    a.click();
}

function restore(e){
    let r=new FileReader();
    r.onload=function(){
        data=JSON.parse(r.result);
        saveLocal(); render();
    };
    r.readAsText(e.target.files[0]);
}

render();
</script>
</body>
</html>
