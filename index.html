<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ú¯Ø§Ù‡ - Ù†Ø³Ø®Ù‡ Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
    <style>
        body { font-family: Tahoma, sans-serif; background: #f4f7f6; padding: 10px; margin: 0; direction: rtl; }
        .box { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .input-group { display: flex; gap: 8px; margin-bottom: 10px; }
        input, textarea { padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-family: Tahoma; font-size: 14px; }
        input { flex: 1; }
        button { padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; font-family: Tahoma; }
        .btn-p { background: #2ecc71; color: white; }
        .btn-s { background: #3498db; color: white; }
        .table-wrap { overflow-x: auto; margin-top: 20px; border-radius: 8px; border: 1px solid #ddd; }
        table { border-collapse: collapse; width: 100%; background: white; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; min-width: 120px; }
        th { background: #34495e; color: white; font-size: 13px; }
        
        /* ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ */
        .cell { cursor: pointer; white-space: pre-wrap; font-size: 12px; min-height: 50px; background: #fff; position: relative; }
        .step-done { background: #d4edda !important; border: 2px solid #28a745 !important; } /* Ù…Ø±Ø­Ù„Ù‡ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ */
        .has-note { background: #fff9c4; border-bottom: 3px solid #fbc02d; } /* ÙÙ‚Ø· ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¯Ø§Ø±Ø¯ */
        .project-done td { background: #c8e6c9 !important; color: #1b5e20; } /* Ú©Ù„ Ù¾Ø±ÙˆÚ˜Ù‡ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ */
        
        .action-link { font-size: 10px; color: #e74c3c; display: block; margin-top: 5px; text-decoration: underline; cursor: pointer; }
        
        /* Modal */
        #modalOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; }
        #noteModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                    background: white; padding: 20px; border-radius: 15px; z-index: 101; width: 85%; max-width: 400px; }
    </style>
</head>
<body>

<div class="box">
    <h3 style="text-align:center; margin-top:0;">ğŸ“‹ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø±Ø§Ø­Ù„ ØªÙˆÙ„ÛŒØ¯</h3>
    
    <div class="input-group">
        <input type="text" id="p_name" placeholder="Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹ CNC)...">
        <button class="btn-p" onclick="fnAddP()">+ Ù¾Ø±ÙˆÚ˜Ù‡</button>
    </div>
    <div class="input-group">
        <input type="text" id="s_name" placeholder="Ù…Ø±Ø­Ù„Ù‡ Ø¬Ø¯ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹ Ø¬ÙˆØ´Ú©Ø§Ø±ÛŒ)...">
        <button class="btn-s" onclick="fnAddS()">+ Ù…Ø±Ø­Ù„Ù‡</button>
    </div>

    <div class="table-wrap">
        <table>
            <thead><tr id="h_row"></tr></thead>
            <tbody id="t_body"></tbody>
        </table>
    </div>
</div>

<div id="modalOverlay" onclick="fnClose()"></div>
<div id="noteModal">
    <h4 id="modalTitle" style="margin-top:0">ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø±Ø­Ù„Ù‡</h4>
    <textarea id="m_txt" style="width:100%; height:100px; box-sizing: border-box;" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª ÙÙ†ÛŒ..."></textarea>
    <br><br>
    <input type="text" id="m_date" style="width:100%; box-sizing: border-box;" placeholder="ØªØ§Ø±ÛŒØ®">
    <div style="display:flex; flex-direction:column; gap:8px; margin-top:15px;">
        <button id="btnFinishStep" style="background:#27ae60; color:white;">âœ… Ø§ØªÙ…Ø§Ù… Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡</button>
        <div style="display:flex; gap:8px;">
            <button class="btn-p" style="flex:1" onclick="fnSave()">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
            <button style="background:#95a5a6; color:white; flex:1" onclick="fnClose()">Ù„ØºÙˆ</button>
        </div>
    </div>
</div>

<script>
    var ST_P = "WORKSHOP_PROJS_V7";
    var ST_S = "WORKSHOP_STEPS_V7";

    var mySteps = JSON.parse(localStorage.getItem(ST_S)) || [];
    var myProjs = JSON.parse(localStorage.getItem(ST_P)) || [];
    var curP = null, curS = null;

    function fnUpdate() {
        localStorage.setItem(ST_S, JSON.stringify(mySteps));
        localStorage.setItem(ST_P, JSON.stringify(myProjs));
        fnDraw();
    }

    function fnAddP() {
        var v = document.getElementById('p_name').value;
        if(v) { myProjs.push({ n: v, d: {}, f: false }); document.getElementById('p_name').value=''; fnUpdate(); }
    }

    function fnAddS() {
        var v = document.getElementById('s_name').value;
        if(v) { mySteps.push(v); document.getElementById('s_name').value=''; fnUpdate(); }
    }

    function fnOpen(pi, si) {
        curP = pi; curS = si;
        var item = myProjs[pi].d[si] || { t: "", dt: new Date().toLocaleDateString('fa-IR'), done: false };
        document.getElementById('modalTitle').innerText = "Ù¾Ø±ÙˆÚ˜Ù‡: " + myProjs[pi].n + " | Ù…Ø±Ø­Ù„Ù‡: " + mySteps[si];
        document.getElementById('m_txt').value = item.t || "";
        document.getElementById('m_date').value = item.dt || new Date().toLocaleDateString('fa-IR');
        
        var btn = document.getElementById('btnFinishStep');
        if(item.done) {
            btn.innerText = "â†©ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…";
            btn.style.background = "#e67e22";
        } else {
            btn.innerText = "âœ… Ø§ØªÙ…Ø§Ù… Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡";
            btn.style.background = "#27ae60";
        }
        btn.onclick = function() { fnToggleStepDone(pi, si); };

        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('noteModal').style.display = 'block';
    }

    function fnToggleStepDone(pi, si) {
        if(!myProjs[pi].d[si]) myProjs[pi].d[si] = { t: "", dt: new Date().toLocaleDateString('fa-IR'), done: false };
        myProjs[pi].d[si].done = !myProjs[pi].d[si].done;
        fnClose();
        fnUpdate();
    }

    function fnSave() {
        if(!myProjs[curP].d[curS]) myProjs[curP].d[curS] = { done: false };
        myProjs[curP].d[curS].t = document.getElementById('m_txt').value;
        myProjs[curP].d[curS].dt = document.getElementById('m_date').value;
        fnClose();
        fnUpdate();
    }

    function fnClose() {
        document.getElementById('modalOverlay').style.display = 'none';
        document.getElementById('noteModal').style.display = 'none';
    }

    function fnDelP(i) { if(confirm('Ø­Ø°Ù Ù¾Ø±ÙˆÚ˜Ù‡ØŸ')) { myProjs.splice(i,1); fnUpdate(); } }
    function fnDelS(i) { if(confirm('Ø­Ø°Ù Ù…Ø±Ø­Ù„Ù‡ØŸ')) { mySteps.splice(i,1); myProjs.forEach(p => delete p.d[i]); fnUpdate(); } }
    function fnToggleProj(i) { myProjs[i].f = !myProjs[i].f; fnUpdate(); }

    function fnDraw() {
        var hr = document.getElementById('h_row');
        hr.innerHTML = '<th>Ù¾Ø±ÙˆÚ˜Ù‡ / Ù…Ø±Ø§Ø­Ù„</th>';
        mySteps.forEach((s, i) => {
            hr.innerHTML += `<th>${s}<span class="action-link" onclick="fnDelS(${i})">Ø­Ø°Ù</span></th>`;
        });

        var tb = document.getElementById('t_body');
        tb.innerHTML = '';
        myProjs.forEach((p, pi) => {
            var rCls = p.f ? 'project-done' : '';
            var row = `<tr class="${rCls}">
                <td>
                    <b>${p.n}</b>
                    <span class="action-link" style="color:#2ecc71" onclick="fnToggleProj(${pi})">${p.f ? 'â†©ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª' : 'âœ… Ø§ØªÙ…Ø§Ù… Ú©Ù„ Ù¾Ø±ÙˆÚ˜Ù‡'}</span>
                    <span class="action-link" onclick="fnDelP(${pi})">ğŸ—‘ Ø­Ø°Ù</span>
                </td>`;
            mySteps.forEach((s, si) => {
                var data = p.d[si] || {t:"", dt:"", done:false};
                var cls = "cell";
                if(data.done) cls += " step-done";
                else if(data.t) cls += " has-note";
                
                var txt = data.t ? `<b>${data.t}</b><br>` : '';
                var dsp = data.done ? `âœ… ØªÙ…Ø§Ù… Ø´Ø¯Ù‡<br>${txt}${data.dt}` : (data.t ? `${txt}${data.dt}` : '---');
                row += `<td class="${cls}" onclick="fnOpen(${pi}, ${si})">${dsp}</td>`;
            });
            row += '</tr>';
            tb.innerHTML += row;
        });
    }

    fnDraw();
</script>
</body>
</html>
