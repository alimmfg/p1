<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Tahoma; padding: 10px; direction: rtl; background: #f9f9f9; }
        .box { background: #fff; padding: 15px; border-radius: 10px; border: 2px solid #ddd; }
        input { padding: 12px; width: 60%; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 5px; }
        button { padding: 10px; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; color: #fff; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #444; padding: 10px; text-align: center; vertical-align: top; }
        th { background: #34495e; color: white; }
        .p-name { cursor: pointer; color: #2c3e50; font-weight: bold; display: block; margin-bottom: 5px; }
        .s-name { cursor: pointer; color: #fff; }
        .done-p { background: #d4edda !important; } 
        .done-s { background: #e3f2fd !important; border: 2px solid #2196f3 !important; } 
        .log-text { text-align: right; font-size: 12px; white-space: pre-wrap; line-height: 1.6; min-height: 20px; }
        .cell-btns { margin-top: 8px; display: flex; gap: 5px; justify-content: center; }
        .btn-tiny { font-size: 9px; padding: 4px 6px; color: #fff; border-radius: 4px; }
        .backup-section { margin-top: 20px; display: flex; gap: 10px; }
    </style>
</head>
<body>

<div class="box">
    <div style="margin-bottom: 20px;">
        <input type="text" id="p_in" placeholder="Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯">
        <button onclick="addProject()" style="background:#27ae60">+ Ù¾Ø±ÙˆÚ˜Ù‡</button>
        <br>
        <input type="text" id="s_in" placeholder="Ù†Ø§Ù… Ù…Ø±Ø­Ù„Ù‡ Ø¬Ø¯ÛŒØ¯">
        <button onclick="addStep()" style="background:#2980b9">+ Ù…Ø±Ø­Ù„Ù‡</button>
    </div>

    <div style="overflow-x: auto;">
        <table>
            <thead id="h_t"></thead>
            <tbody id="b_t"></tbody>
        </table>
    </div>

    <div class="backup-section">
        <button onclick="exportData()" style="flex: 1; background:#8e44ad;">ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
        <button onclick="document.getElementById('fileIn').click()" style="flex: 1; background:#d63031;">ğŸ“¥ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ (Import)</button>
        <input type="file" id="fileIn" style="display:none" onchange="importData(event)">
    </div>
</div>

<script>
    var prjs = JSON.parse(localStorage.getItem('P_DATA_V3')) || [];
    var stps = JSON.parse(localStorage.getItem('S_DATA_V3')) || [];

    function refresh() {
        localStorage.setItem('P_DATA_V3', JSON.stringify(prjs));
        localStorage.setItem('S_DATA_V3', JSON.stringify(stps));

        var h = document.getElementById('h_t');
        var headHtml = '<tr><th>Ù¾Ø±ÙˆÚ˜Ù‡</th>';
        for(var i=0; i<stps.length; i++) {
            headHtml += '<th><span class="s-name" onclick="editS('+i+')">'+stps[i]+'</span><br><small onclick="delS('+i+')" style="color:#ff7675;cursor:pointer;font-size:10px">[Ø­Ø°Ù]</small></th>';
        }
        h.innerHTML = headHtml + '</tr>';

        var b = document.getElementById('b_t');
        b.innerHTML = '';
        for(var j=0; j<prjs.length; j++) {
            var p = prjs[j];
            var rowHtml = '<tr class="'+(p.f?'done-p':'')+'">';
            rowHtml += '<td><span class="p-name" onclick="editP('+j+')">'+p.n+'</span>' +
                       '<button onclick="toggleP('+j+')" class="btn-tiny" style="background:#636e72">'+(p.f?'Ø¨Ø§Ø²Ú¯Ø´Øª':'Ø§ØªÙ…Ø§Ù… Ú©Ù„')+'</button></td>';
            
            for(var k=0; k<stps.length; k++) {
                var d = p.d[k] || {t:'', f:false};
                var cellClass = d.f ? 'done-s' : '';
                rowHtml += '<td class="'+cellClass+'">' +
                           '<div class="log-text" onclick="editCell('+j+','+k+')">' + (d.t || '---') + '</div>' +
                           '<div class="cell-btns">' +
                           '<button onclick="toggleStep('+j+','+k+')" class="btn-tiny" style="background:#0984e3">'+(d.f?'â†©':'âœ… Ø§ØªÙ…Ø§Ù…')+'</button>' +
                           '</div></td>';
            }
            rowHtml += '</tr>';
            b.innerHTML += rowHtml;
        }
    }

    function addProject() {
        var v = document.getElementById('p_in').value;
        if(v) { prjs.push({n:v, d:{}, f:false}); document.getElementById('p_in').value=''; refresh(); }
    }

    function addStep() {
        var v = document.getElementById('s_in').value;
        if(v) { stps.push(v); document.getElementById('s_in').value=''; refresh(); }
    }

    function editP(i) { var n = prompt("ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡:", prjs[i].n); if(n) { prjs[i].n = n; refresh(); } }
    function editS(i) { var n = prompt("ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ø§Ù… Ù…Ø±Ø­Ù„Ù‡:", stps[i]); if(n) { stps[i] = n; refresh(); } }

    function editCell(pi, si) {
        if(!prjs[pi].d[si]) prjs[pi].d[si] = {t:'', f:false};
        var txt = prompt("ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¬Ø¯ÛŒØ¯:");
        if(txt) {
            var now = new Date();
            var time = "[" + now.getHours() + ":" + (now.getMinutes()<10?'0':'') + now.getMinutes() + "]";
            var newEntry = time + " " + txt;
            prjs[pi].d[si].t = newEntry + "\n" + prjs[pi].d[si].t;
            refresh();
        }
    }

    function toggleStep(pi, si) {
        if(!prjs[pi].d[si]) prjs[pi].d[si] = {t:'', f:false};
        prjs[pi].d[si].f = !prjs[pi].d[si].f;
        refresh();
    }

    function toggleP(i) { prjs[i].f = !prjs[i].f; refresh(); }
    function delS(i) { if(confirm('Ø­Ø°Ù Ù…Ø±Ø­Ù„Ù‡ØŸ')) { stps.splice(i,1); refresh(); } }

    function exportData() {
        var blob = new Blob([JSON.stringify({prjs, stps})], {type: 'application/json'});
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "workshop_backup.json"; a.click();
    }

    function importData(event) {
        var file = event.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var data = JSON.parse(e.target.result);
                if (data.prjs && data.stps) {
                    prjs = data.prjs;
                    stps = data.stps;
                    refresh();
                    alert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯.");
                }
            } catch (err) { alert("ÙØ§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª."); }
        };
        reader.readAsText(file);
    }

    refresh();
</script>
</body>
</html>
