<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: Tahoma; background: #f4f7f6; padding: 20px; direction: rtl; font-size: 16px; }
        .container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); max-width: 1200px; margin: auto; }
        input, textarea { padding: 15px; border: 1px solid #ddd; border-radius: 10px; font-family: Tahoma; margin: 8px 0; width: 100%; box-sizing: border-box; font-size: 16px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 25px; }
        th, td { border: 2px solid #444; padding: 15px; text-align: center; vertical-align: top; font-size: 16px; }
        th { background: #2c3e50; color: white; font-size: 18px; }
        
        .clickable { cursor: pointer; transition: 0.2s; }
        .clickable:hover { color: #e67e22; background: #fdf2e9; }

        .note-box { background: #feffd4; border: 1px solid #d4d442; padding: 12px; margin-bottom: 8px; border-radius: 8px; text-align: right; font-size: 15px; white-space: pre-wrap; line-height: 1.6; }
        .time-tag { color: #c0392b; font-size: 12px; font-weight: bold; border-bottom: 1px solid #ddd; display: block; margin-bottom: 5px; padding-bottom: 3px; }

        /* Ù¾Ù†Ø¬Ø±Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª - Ø¯Ø±Ø´Øªâ€ŒØªØ± */
        #modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 20px; box-shadow: 0 0 60px rgba(0,0,0,0.6); z-index: 1000; width: 90%; max-width: 500px; }
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; }
        
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; }
        .btn-p { background: #27ae60; color: white; width: 150px; }
        .btn-s { background: #2980b9; color: white; width: 150px; }
        .btn-save { background: #27ae60; color: white; width: 100%; padding: 18px; margin-top: 15px; font-size: 18px; }
        
        .backup-section { margin-top: 40px; display: flex; gap: 15px; flex-wrap: wrap; }
        .btn-backup { background: #8e44ad; color: white; flex: 1; min-width: 200px; }
        .btn-restore { background: #e67e22; color: white; flex: 1; min-width: 200px; }
        
        small { font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center; color: #2c3e50;">Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ú¯Ø§Ù‡</h1>
    
    <div style="display:flex; gap:15px; align-items:center; flex-wrap: wrap;">
        <input type="text" id="p_name" placeholder="Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯..." style="flex: 2;">
        <button class="btn btn-p" onclick="addProject()">+ Ø«Ø¨Øª Ù¾Ø±ÙˆÚ˜Ù‡</button>
    </div>
    <div style="display:flex; gap:15px; align-items:center; flex-wrap: wrap;">
        <input type="text" id="s_name" placeholder="Ù†Ø§Ù… Ù…Ø±Ø­Ù„Ù‡ Ø¬Ø¯ÛŒØ¯..." style="flex: 2;">
        <button class="btn btn-s" onclick="addStep()">+ Ø«Ø¨Øª Ù…Ø±Ø­Ù„Ù‡</button>
    </div>

    <div style="overflow-x: auto;">
        <table>
            <thead id="h_row"></thead>
            <tbody id="b_rows"></tbody>
        </table>
    </div>

    <div class="backup-section">
        <button onclick="downloadBackup()" class="btn btn-backup">ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ø³Ø®Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù† (Ø¨Ú©â€ŒØ¢Ù¾)</button>
        <button onclick="document.getElementById('fileIn').click()" class="btn btn-restore">ğŸ“¥ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ ÙØ§ÛŒÙ„ (Restore)</button>
        <input type="file" id="fileIn" style="display:none" onchange="uploadBackup(event)">
    </div>
</div>

<div id="overlay" onclick="closeNote()"></div>
<div id="modal">
    <h3 id="m_title" style="margin-top: 0;">ÙˆÛŒØ±Ø§ÛŒØ´ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</h3>
    <textarea id="m_text" rows="12" placeholder="Ù…ØªÙ† ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
    <button class="btn btn-save" onclick="saveNote()">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
</div>

<script>
    let data = JSON.parse(localStorage.getItem('MY_WORKSHOP_DB_V2')) || { projects: [], steps: [] };
    let currentEdit = null;

    function render() {
        localStorage.setItem('MY_WORKSHOP_DB_V2', JSON.stringify(data));
        
        let head = '<tr><th>Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡</th>';
        data.steps.forEach((s, i) => {
            head += `<th class="clickable" onclick="editStepName(${i})">${s} <br><small style="color:#ffcccc; cursor:pointer" onclick="delStep(event, ${i})">[Ø­Ø°Ù Ù…Ø±Ø­Ù„Ù‡]</small></th>`;
        });
        document.getElementById('h_row').innerHTML = head + '</tr>';

        let body = '';
        data.projects.forEach((p, pi) => {
            body += `<tr>
                <td class="clickable" onclick="editProjName(${pi})"><strong>${p.name}</strong><br><small style="color:#e74c3c; cursor:pointer" onclick="delProj(event, ${pi})">[Ø­Ø°Ù Ù¾Ø±ÙˆÚ˜Ù‡]</small></td>`;
            data.steps.forEach((s, si) => {
                let cell = p.cells[si] || { logs: [] };
                let logsHtml = cell.logs.map((l, li) => 
                    `<div class="note-box" onclick="openNote(${pi}, ${si}, ${li})"><span class="time-tag">${l.time}</span>${l.text}</div>`
                ).join('');
                body += `<td onclick="openNote(${pi}, ${si})" style="min-width: 200px;">${logsHtml || '<small style="color:#bbb">Ø¨Ø±Ø§ÛŒ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</small>'}</td>`;
            });
            body += '</tr>';
        });
        document.getElementById('b_rows').innerHTML = body;
    }

    function openNote(pi, si, li = null) {
        currentEdit = { pi, si, li };
        let text = li !== null ? data.projects[pi].cells[si].logs[li].text : "";
        document.getElementById('m_text').value = text;
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('modal').style.display = 'block';
    }

    function saveNote() {
        let { pi, si, li } = currentEdit;
        let newText = document.getElementById('m_text').value.trim();
        let now = new Date().toLocaleDateString('fa-IR') + " Ø³Ø§Ø¹Øª " + new Date().getHours() + ":" + (new Date().getMinutes() < 10 ? '0' : '') + new Date().getMinutes();

        if (!data.projects[pi].cells[si]) data.projects[pi].cells[si] = { logs: [] };

        if (li !== null) {
            let oldText = data.projects[pi].cells[si].logs[li].text;
            if (oldText !== newText) {
                data.projects[pi].cells[si].logs[li].text = newText + "\n-------------------\n(Ø§ØµÙ„Ø§Ø­ Ø¯Ø±: " + now + ")";
            }
        } else if (newText !== "") {
            data.projects[pi].cells[si].logs.unshift({ time: now, text: newText });
        }
        closeNote();
        render();
    }

    function closeNote() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('modal').style.display = 'none';
    }

    function addProject() {
        let name = document.getElementById('p_name').value;
        if (name) { data.projects.push({ name, cells: {} }); document.getElementById('p_name').value = ''; render(); }
    }

    function addStep() {
        let name = document.getElementById('s_name').value;
        if (name) { data.steps.push(name); document.getElementById('s_name').value = ''; render(); }
    }

    function editProjName(i) { let n = prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ù¾Ø±ÙˆÚ˜Ù‡:", data.projects[i].name); if(n) { data.projects[i].name = n; render(); } }
    function editStepName(i) { let n = prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ù…Ø±Ø­Ù„Ù‡:", data.steps[i]); if(n) { data.steps[i] = n; render(); } }
    function delProj(e, i) { e.stopPropagation(); if(confirm("Ø¢ÛŒØ§ Ù¾Ø±ÙˆÚ˜Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) { data.projects.splice(i, 1); render(); } }
    function delStep(e, i) { e.stopPropagation(); if(confirm("Ø¢ÛŒØ§ Ù…Ø±Ø­Ù„Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) { data.steps.splice(i, 1); render(); } }

    function downloadBackup() {
        let blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        let a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "workshop_backup_" + new Date().getTime() + ".json";
        a.click();
    }

    function uploadBackup(e) {
        let reader = new FileReader();
        reader.onload = function(ev) {
            try {
                let imported = JSON.parse(ev.target.result);
                if (imported.projects && imported.steps) {
                    data = imported;
                    render();
                    alert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯.");
                }
            } catch (err) { alert("Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ø¨Ú©â€ŒØ¢Ù¾!"); }
        };
        reader.readAsText(e.target.files[0]);
    }

    render();
</script>
</body>
</html>
