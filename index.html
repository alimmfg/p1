<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ú¯Ø§Ù‡</title>
    <style>
        body { font-family: Tahoma, sans-serif; background: #eee; padding: 10px; }
        .card { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input { padding: 10px; width: 140px; margin: 5px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 15px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #fff; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; font-size: 13px; }
        th { background: #333; color: #fff; }
        .cell { cursor: pointer; min-height: 50px; white-space: pre-wrap; background: #fdfdfd; }
        .done-step { background: #d4edda !important; border: 2px solid #28a745 !important; }
        .done-proj { background: #c3e6cb !important; }
        
        #modal { display: none; position: fixed; top: 15%; left: 5%; right: 5%; background: #fff; 
                 padding: 20px; border: 2px solid #333; z-index: 1000; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; }
    </style>
</head>
<body>

<div class="card">
    <h3 style="margin-top:0">ğŸ›  Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÙ„ÛŒØ¯ Ú©Ø§Ø±Ú¯Ø§Ù‡</h3>
    <input type="text" id="ip" placeholder="Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡">
    <button style="background:#28a745; color:#fff;" onclick="addP()">+ Ù¾Ø±ÙˆÚ˜Ù‡</button>
    <br>
    <input type="text" id="is" placeholder="Ù†Ø§Ù… Ù…Ø±Ø­Ù„Ù‡">
    <button style="background:#007bff; color:#fff;" onclick="addS()">+ Ù…Ø±Ø­Ù„Ù‡</button>

    <div style="overflow-x:auto;">
        <table>
            <thead id="h"></thead>
            <tbody id="b"></tbody>
        </table>
    </div>
</div>

<div id="overlay" onclick="closeM()"></div>
<div id="modal">
    <h4 id="mt"></h4>
    <textarea id="txt" style="width:100%; height:100px; font-family:Tahoma;" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¬Ø¯ÛŒØ¯..."></textarea>
    <br><br>
    <button style="background:#28a745; color:#fff; width:100%; padding:12px;" onclick="saveN()">â• Ø«Ø¨Øª Ø¨Ø§ Ø³Ø§Ø¹Øª Ø¬Ø§Ø±ÛŒ</button>
    <br><br>
    <button id="fb" style="width:100%; padding:12px;">âœ… Ø§ØªÙ…Ø§Ù… Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡</button>
    <br><br>
    <button style="background:#6c757d; color:#fff; width:100%;" onclick="closeM()">Ø¨Ø³ØªÙ†</button>
</div>

<script>
    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø³Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¬Ù‡Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù†
    var S = JSON.parse(localStorage.getItem('DB_STEPS_NEW')) || [];
    var P = JSON.parse(localStorage.getItem('DB_PROJS_NEW')) || [];
    var cp, cs;

    function render() {
        localStorage.setItem('DB_STEPS_NEW', JSON.stringify(S));
        localStorage.setItem('DB_PROJS_NEW', JSON.stringify(P));

        var h = document.getElementById('h');
        h.innerHTML = '<tr><th>Ù¾Ø±ÙˆÚ˜Ù‡</th>' + S.map((s, i) => '<th>'+s+'<br><span style="color:red;cursor:pointer;font-size:10px;" onclick="delS('+i+')">(Ø­Ø°Ù)</span></th>').join('') + '</tr>';

        var b = document.getElementById('b');
        b.innerHTML = '';
        P.forEach((p, pi) => {
            var row = '<tr class="'+(p.f?'done-proj':'')+'"><td><b>'+p.n+'</b><br><span style="color:green;cursor:pointer;font-size:10px;" onclick="finP('+pi+')">ØªÙ…Ø§Ù…/Ø§Ø¯Ø§Ù…Ù‡</span> | <span style="color:red;cursor:pointer;font-size:10px;" onclick="delP('+pi+')">Ø­Ø°Ù</span></td>';
            S.forEach((s, si) => {
                var d = p.d[si] || {t:'', f:false};
                var cls = d.f ? 'cell done-step' : 'cell';
                row += '<td class="'+cls+'" onclick="openM('+pi+','+si+')">' + (d.f?'[ØªÙ…Ø§Ù…] ':'') + d.t + '</td>';
            });
            row += '</tr>';
            b.innerHTML += row;
        });
    }

    function addP() { var v = document.getElementById('ip').value; if(v){ P.push({n:v, d:{}, f:false}); document.getElementById('ip').value=''; render(); } }
    function addS() { var v = document.getElementById('is').value; if(v){ S.push(v); document.getElementById('is').value=''; render(); } }
    
    function openM(pi, si) {
        cp = pi; cs = si;
        var d = P[pi].d[si] || {t:'', f:false};
        document.getElementById('mt').innerText = P[pi].n + ' > ' + S[si];
        document.getElementById('txt').value = '';
        document.getElementById('modal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
        
        var fb = document.getElementById('fb');
        fb.style.background = d.f ? "orange" : "#28a745";
        fb.innerText = d.f ? "â†©ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØªÙˆÙ„ÛŒØ¯" : "âœ… Ø§ØªÙ…Ø§Ù… Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡";
        fb.onclick = function() {
            if(!P[cp].d[cs]) P[cp].d[cs] = {t:'', f:false};
            P[cp].d[cs].f = !P[cp].d[cs].f;
            closeM(); render();
        };
    }

    function saveN() {
        var v = document.getElementById('txt').value;
        if(!v) return;
        if(!P[cp].d[cs]) P[cp].d[cs] = {t:'', f:false};
        var n = new Date();
        var time = n.toLocaleDateString('fa-IR') + ' Ø³Ø§Ø¹Øª ' + n.getHours() + ':' + n.getMinutes();
        P[cp].d[cs].t = time + ': ' + v + '\n' + (P[cp].d[cs].t || '');
        closeM(); render();
    }

    function finP(i) { P[i].f = !P[i].f; render(); }
    function delP(i) { if(confirm('Ø­Ø°ÙØŸ')) { P.splice(i,1); render(); } }
    function delS(i) { if(confirm('Ø­Ø°ÙØŸ')) { S.splice(i,1); render(); } }
    function closeM() { document.getElementById('modal').style.display='none'; document.getElementById('overlay').style.display='none'; }

    render();
</script>
</body>
</html>
