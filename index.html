<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: Tahoma; background: #f4f7f6; padding: 20px; direction: rtl; }
        .container { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        input, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: Tahoma; margin: 5px 0; width: 100%; box-sizing: border-box; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #444; padding: 10px; text-align: center; vertical-align: top; }
        th { background: #2c3e50; color: white; }
        
        .clickable { cursor: pointer; transition: 0.2s; }
        .clickable:hover { color: #e67e22; background: #fdf2e9; }

        .note-box { background: #feffd4; border: 1px solid #d4d442; padding: 8px; margin-bottom: 5px; border-radius: 5px; text-align: right; font-size: 13px; white-space: pre-wrap; }
        .time-tag { color: #c0392b; font-size: 10px; font-weight: bold; border-bottom: 1px solid #ddd; display: block; margin-bottom: 3px; }

        /* Ù¾Ù†Ø¬Ø±Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª */
        #modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 15px; box-shadow: 0 0 50px rgba(0,0,0,0.5); z-index: 1000; width: 400px; }
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; }
        
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-p { background: #27ae60; color: white; width: 120px; }
        .btn-s { background: #2980b9; color: white; width: 120px; }
        .btn-save { background: #27ae60; color: white; width: 100%; padding: 12px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center">Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ú¯Ø§Ù‡</h2>
    
    <div style="display:flex; gap:10px; align-items:center">
        <input type="text" id="p_name" placeholder="Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡">
        <button class="btn btn-p" onclick="addProject()">+ Ù¾Ø±ÙˆÚ˜Ù‡</button>
    </div>
    <div style="display:flex; gap:10px; align-items:center">
        <input type="text" id="s_name" placeholder="Ù†Ø§Ù… Ù…Ø±Ø­Ù„Ù‡">
        <button class="btn btn-s" onclick="addStep()">+ Ù…Ø±Ø­Ù„Ù‡</button>
    </div>

    <div style="overflow-x: auto;">
        <table>
            <thead id="h_row"></thead>
            <tbody id="b_rows"></tbody>
        </table>
    </div>

    <div style="margin-top:30px; display:flex; gap:10px">
        <button onclick="downloadBackup()" style="background:#8e44ad; color:white;" class="btn">ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ø³Ø®Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù† (Ø¨Ú©â€ŒØ¢Ù¾)</button>
        <button onclick="document.getElementById('fileIn').click()" style="background:#e67e22; color:white;" class="btn">ğŸ“¥ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ ÙØ§ÛŒÙ„ (Restore)</button>
        <input type="file" id="fileIn" style="display:none" onchange="uploadBackup(event)">
    </div>
</div>

<div id="overlay" onclick="closeNote()"></div>
<div id="modal">
    <h4 id="m_title">ÙˆÛŒØ±Ø§ÛŒØ´ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</h4>
    <textarea id="m_text" rows="10" placeholder="Ù…ØªÙ† Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯... (Ø§ÛŒÙ†ØªØ± Ø¨Ø²Ù†ÛŒØ¯)"></textarea>
    <button class="btn btn-save" onclick="saveNote()">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
</div>

<script>
    let data = JSON.parse(localStorage.getItem('MY_WORKSHOP_DB')) || { projects: [], steps: [] };
    let currentEdit = null;

    function render() {
        localStorage.setItem('MY_WORKSHOP_DB', JSON.stringify(data));
        
        // Ø±Ù†Ø¯Ø± Ø³Ø±ØªÛŒØªØ±
        let head = '<tr><th>Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡</th>';
        data.steps.forEach((s, i) => {
            head += `<th class="clickable" onclick="editStepName(${i})">${s} <br><small style="color:#ff7675" onclick="delStep(event, ${i})">[Ø­Ø°Ù]</small></th>`;
        });
        document.getElementById('h_row').innerHTML = head + '</tr>';

        // Ø±Ù†Ø¯Ø± Ø¨Ø¯Ù†Ù‡
        let body = '';
        data.projects.forEach((p, pi) => {
            body += `<tr>
                <td class="clickable" onclick="editProjName(${pi})"><b>${p.name}</b><br><small style="color:red" onclick="delProj(event, ${pi})">[Ø­Ø°Ù Ú©Ù„]</small></td>`;
            data.steps.forEach((s, si) => {
                let cell = p.cells[si] || { logs: [] };
                let logsHtml = cell.logs.map((l, li) => 
                    `<div class="note-box" onclick="openNote(${pi}, ${si}, ${li})"><span class="time-tag">${l.time}</span>${l.text}</div>`
                ).join('');
                body += `<td onclick="openNote(${pi}, ${si})">${logsHtml || '<small style="color:#ccc">Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</small>'}</td>`;
            });
            body += '</tr>';
        });
        document.getElementById('b_rows').innerHTML = body;
    }

    function openNote(pi, si, li = null) {
        currentEdit = { pi, si, li };
        let text = li !== null ? data.projects[pi].cells[si].logs[li].text : "";
        document.getElementById('m_text').value = text;
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('modal').style.display = 'block';
    }

    function saveNote() {
        let { pi, si, li } = currentEdit;
        let newText = document.getElementById('m_text').value.trim();
        let now = new Date().toLocaleDateString('fa-IR') + " Ø³Ø§Ø¹Øª " + new Date().getHours() + ":" + new Date().getMinutes();

        if (!data.projects[pi].cells[si]) data.projects[pi].cells[si] = { logs: [] };

        if (li !== null) {
            // ÙˆÛŒØ±Ø§ÛŒØ´ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ù‚Ø¨Ù„ÛŒ
            if (data.projects[pi].cells[si].logs[li].text !== newText) {
                data.projects[pi].cells[si].logs[li].text = newText + "\n(Ø§ØµÙ„Ø§Ø­ Ø¯Ø±: " + now + ")";
            }
        } else if (newText !== "") {
            // ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¬Ø¯ÛŒØ¯
            data.projects[pi].cells[si].logs.unshift({ time: now, text: newText });
        }
        closeNote();
        render();
    }

    function closeNote() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('modal').style.display = 'none';
    }

    function addProject() {
        let name = document.getElementById('p_name').value;
        if (name) { data.projects.push({ name, cells: {} }); document.getElementById('p_name').value = ''; render(); }
    }

    function addStep() {
        let name = document.getElementById('s_name').value;
        if (name) { data.steps.push(name); document.getElementById('s_name').value = ''; render(); }
    }

    function editProjName(i) { let n = prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ù¾Ø±ÙˆÚ˜Ù‡:", data.projects[i].name); if(n) { data.projects[i].name = n; render(); } }
    function editStepName(i) { let n = prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ù…Ø±Ø­Ù„Ù‡:", data.steps[i]); if(n) { data.steps[i] = n; render(); } }
    function delProj(e, i) { e.stopPropagation(); if(confirm("Ø­Ø°Ù Ù¾Ø±ÙˆÚ˜Ù‡ØŸ")) { data.projects.splice(i, 1); render(); } }
    function delStep(e, i) { e.stopPropagation(); if(confirm("Ø­Ø°Ù Ù…Ø±Ø­Ù„Ù‡ØŸ")) { data.steps.splice(i, 1); render(); } }

    // --- ØªÙˆØ§Ø¨Ø¹ Ø¨Ú©â€ŒØ¢Ù¾ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ ---
    function downloadBackup() {
        let blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        let a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "workshop_data.json";
        a.click();
    }

    function uploadBackup(e) {
        let reader = new FileReader();
        reader.onload = function(ev) {
            try {
                let imported = JSON.parse(ev.target.result);
                if (imported.projects && imported.steps) {
                    data = imported;
                    render();
                    alert("Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯.");
                }
            } catch (err) { alert("ÙØ§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª."); }
        };
        reader.readAsText(e.target.files[0]);
    }

    render();
</script>
</body>
</html>
