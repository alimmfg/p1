<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ú¯Ø§Ù‡ v11</title>
    <style>
        body { font-family: Tahoma, sans-serif; background: #f0f2f5; padding: 10px; direction: rtl; }
        .box { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 1000px; margin: auto; }
        .input-group { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        input, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-family: Tahoma; }
        input { flex: 1; min-width: 150px; }
        button { padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-p { background: #27ae60; color: white; }
        .btn-s { background: #2980b9; color: white; }
        .table-wrap { overflow-x: auto; margin-top: 20px; border: 1px solid #ddd; border-radius: 8px; }
        table { border-collapse: collapse; width: 100%; background: white; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; min-width: 130px; }
        th { background: #34495e; color: white; font-size: 13px; }
        .cell { cursor: pointer; white-space: pre-wrap; font-size: 11px; background: #fff; line-height: 1.5; }
        .step-done { background: #d4edda !important; border: 2px solid #28a745 !important; }
        .proj-done { background: #e8f5e9 !important; color: #1b5e20; }
        .action-link { font-size: 10px; color: #e74c3c; display: block; margin-top: 5px; text-decoration: underline; cursor: pointer; }
        
        /* Modal */
        #modalOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; }
        #noteModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                    background: white; padding: 20px; border-radius: 15px; z-index: 101; width: 85%; max-width: 400px; }
    </style>
</head>
<body>

<div class="box">
    <h3 style="text-align:center;">ğŸ›  Ù…Ø¯ÛŒØ±ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯ ØªÙˆÙ„ÛŒØ¯ (Ø¨Ø§ Ø³Ø§Ø¹Øª Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡)</h3>
    
    <div class="input-group">
        <input type="text" id="p_in" placeholder="Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯">
        <button class="btn-p" onclick="addP()">+ Ù¾Ø±ÙˆÚ˜Ù‡</button>
        <input type="text" id="s_in" placeholder="Ù…Ø±Ø­Ù„Ù‡ Ø¬Ø¯ÛŒØ¯">
        <button class="btn-s" onclick="addS()">+ Ù…Ø±Ø­Ù„Ù‡</button>
    </div>

    <div class="table-wrap">
        <table>
            <thead><tr id="h_row"></tr></thead>
            <tbody id="t_body"></tbody>
        </table>
    </div>
</div>

<div id="modalOverlay" onclick="closeM()"></div>
<div id="noteModal">
    <h4 id="mTitle" style="margin-top:0">Ø«Ø¨Øª Ú¯Ø²Ø§Ø±Ø´ Ù…Ø±Ø­Ù„Ù‡</h4>
    <textarea id="m_txt" style="width:100%; height:100px; box-sizing: border-box;" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¬Ø¯ÛŒØ¯..."></textarea>
    <div style="display:flex; flex-direction:column; gap:10px; margin-top:15px;">
        <button id="btnFinish" style="background:#27ae60; color:white;">âœ… Ø§ØªÙ…Ø§Ù… Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡</button>
        <div style="display:flex; gap:8px;">
            <button class="btn-p" style="flex:2" onclick="saveM()">â• Ø«Ø¨Øª Ø¨Ø§ Ø³Ø§Ø¹Øª Ø¬Ø§Ø±ÛŒ</button>
            <button style="background:#e74c3c; color:white; flex:1" onclick="clearC()">ğŸ—‘ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ</button>
        </div>
        <button style="background:#95a5a6; color:white;" onclick="closeM()">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>
</div>

<script>
    // Ú©Ù„ÛŒØ¯ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ¯Ø§Ø®Ù„
    var KEY_P = "WORKSHOP_DATA_P_FINAL";
    var KEY_S = "WORKSHOP_DATA_S_FINAL";

    var steps = JSON.parse(localStorage.getItem(KEY_S)) || [];
    var projs = JSON.parse(localStorage.getItem(KEY_P)) || [];
    var curP = null, curS = null;

    function render() {
        localStorage.setItem(KEY_S, JSON.stringify(steps));
        localStorage.setItem(KEY_P, JSON.stringify(projs));

        var hr = document.getElementById('h_row');
        hr.innerHTML = '<th>Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡</th>';
        steps.forEach((s, i) => hr.innerHTML += `<th>${s}<span class="action-link" onclick="delS(${i})">Ø­Ø°Ù</span></th>`);

        var tb = document.getElementById('t_body');
        tb.innerHTML = '';
        projs.forEach((p, pi) => {
            var rCls = p.f ? 'proj-done' : '';
            var row = `<tr class="${rCls}">
                <td>
                    <b>${p.n}</b>
                    <span class="action-link" style="color:#27ae60" onclick="toggleP(${pi})">${p.f ? 'â†©ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª' : 'âœ… Ø§ØªÙ…Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡'}</span>
                    <span class="action-link" onclick="delP(${pi})">ğŸ—‘ Ø­Ø°Ù</span>
                </td>`;
            steps.forEach((s, si) => {
                var d = p.d[si] || {t:"", f:false};
                var cls = "cell " + (d.f ? "step-done" : (d.t ? "has-note" : ""));
                row += `<td class="${cls}" onclick="openM(${pi}, ${si})">${d.f ? 'âœ… ØªÙ…Ø§Ù… Ø´Ø¯Ù‡<br>' : ''}${d.t || '---'}</td>`;
            });
            row += '</tr>';
            tb.innerHTML += row;
        });
    }

    function addP() {
        var v = document.getElementById('p_in').value;
        if(v) { projs.push({n:v, d:{}, f:false}); document.getElementById('p_in').value=''; render(); }
    }

    function addS() {
        var v = document.getElementById('s_in').value;
        if(v) { steps.push(v); document.getElementById('s_in').value=''; render(); }
    }

    function openM(pi, si) {
        curP = pi; curS = si;
        var d = projs[pi].d[si] || {t:"", f:false};
        document.getElementById('m_txt').value = "";
        document.getElementById('mTitle').innerText = projs[pi].n + " > " + steps[si];
        
        var btn = document.getElementById('btnFinish');
        btn.innerText = d.f ? "â†©ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØªÙˆÙ„ÛŒØ¯" : "âœ… Ø§ØªÙ…Ø§Ù… Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡";
        btn.style.background = d.f ? "#e67e22" : "#27ae60";
        btn.onclick = function() {
            if(!projs[curP].d[curS]) projs[curP].d[curS] = {t:"", f:false};
            projs[curP].d[curS].f = !projs[curP].d[curS].f;
            closeM(); render();
        };

        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('noteModal').style.display = 'block';
    }

    function saveM() {
        var txt = document.getElementById('m_txt').value;
        if(!txt) return;
        if(!projs[curP].d[curS]) projs[curP].d[curS] = {t:"", f:false};
        
        var now = new Date();
        var stamp = now.toLocaleDateString('fa-IR') + " [" + now
