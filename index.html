<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ú¯Ø§Ù‡ - Ù†Ø³Ø®Ù‡ Ú©Ø§Ù…Ù„</title>
    <style>
        body { font-family: Tahoma, sans-serif; padding: 10px; background: #f4f7f6; direction: rtl; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 60%; margin-bottom: 5px; }
        button { padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-add { background: #27ae60; color: white; margin-bottom: 5px; }
        .btn-step { background: #2980b9; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ccc; padding: 12px; text-align: center; font-size: 13px; }
        th { background: #34495e; color: white; }
        td { cursor: pointer; white-space: pre-wrap; min-height: 60px; }
        td:hover { background: #f9f9f9; }
        .backup-btn { background: #8e44ad; color: white; width: 100%; margin-top: 20px; }
    </style>
</head>
<body>

<div class="card">
    <h3 style="margin-top:0">ğŸ›  Ù…Ø¯ÛŒØ±ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ú©Ø§Ø±Ú¯Ø§Ù‡</h3>
    
    <input type="text" id="pIn" placeholder="Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯">
    <button class="btn-add" onclick="addP()">+ Ù¾Ø±ÙˆÚ˜Ù‡</button>
    <br>
    <input type="text" id="sIn" placeholder="Ù…Ø±Ø­Ù„Ù‡ Ø¬Ø¯ÛŒØ¯">
    <button class="btn-step" onclick="addS()">+ Ù…Ø±Ø­Ù„Ù‡</button>

    <div style="overflow-x: auto;">
        <table>
            <thead id="h"></thead>
            <tbody id="b"></tbody>
        </table>
    </div>

    <button class="backup-btn" onclick="exportJSON()">ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† (Cloud Backup)</button>
</div>

<script>
    var S = JSON.parse(localStorage.getItem('S_V14')) || [];
    var P = JSON.parse(localStorage.getItem('P_V14')) || [];

    function render() {
        localStorage.setItem('S_V14', JSON.stringify(S));
        localStorage.setItem('P_V14', JSON.stringify(P));

        document.getElementById('h').innerHTML = '<tr><th>Ù¾Ø±ÙˆÚ˜Ù‡</th>' + S.map((s,i) => `<th>${s}<br><small onclick="delS(${i})" style="color:#e74c3c;cursor:pointer;">(Ø­Ø°Ù)</small></th>`).join('') + '</tr>';

        var html = '';
        P.forEach((p, pi) => {
            html += `<tr><td style="background:#eee"><b>${p.n}</b><br><small onclick="delP(${pi})" style="color:#e74c3c;cursor:pointer;">(Ø­Ø°Ù Ù¾Ø±ÙˆÚ˜Ù‡)</small></td>`;
            S.forEach((s, si) => {
                var content = p.d[si] || '';
                html += `<td onclick="editCell(${pi}, ${si})">${content}</td>`;
            });
            html += '</tr>';
        });
        document.getElementById('b').innerHTML = html;
    }

    function addP() { var v = document.getElementById('pIn').value; if(v){ P.push({n:v, d:{}}); document.getElementById('pIn').value=''; render(); } }
    function addS() { var v = document.getElementById('sIn').value; if(v){ S.push(v); document.getElementById('sIn').value=''; render(); } }
    function delP(i) { if(confirm('Ú©Ù„ Ù¾Ø±ÙˆÚ˜Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) { P.splice(i,1); render(); } }
    function delS(i) { if(confirm('Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) { S.splice(i,1); P.forEach(p=>delete p.d[i]); render(); } }

    function editCell(pi, si) {
        var oldText = P[pi].d[si] || '';
        // Ø­Ø°Ù ØªÚ¯â€ŒÙ‡Ø§ÛŒ <br> Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ØªÙ…ÛŒØ² Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´
        var cleanText = oldText.replace(/<br>/g, '\n');
        
        var newNote = prompt("ÙˆÛŒØ±Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´ (Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø²Ù…Ø§Ù† Ø¬Ø¯ÛŒØ¯ØŒ Ù…ØªÙ† Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯):", cleanText);
        
        if (newNote !== null) {
            if (newNote.trim() === "") {
                P[pi].d[si] = ""; // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø³Ù„ÙˆÙ„
            } else if (newNote !== cleanText) {
                // Ø§Ú¯Ø± Ù…ØªÙ† ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ø³Ø§Ø¹Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ø²Ù†
                var now = new Date();
                var stamp = now.toLocaleDateString('fa-IR') + " [" + now.getHours() + ":" + now.getMinutes() + "]";
                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…ØªÙ† Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø§Ø¨ØªØ¯Ø§ÛŒ Ù…ØªÙ† Ù‚Ø¨Ù„ÛŒ
                P[pi].d[si] = stamp + ": " + newNote.replace(/\n/g, '<br>') + "<br>" + oldText;
            }
            render();
        }
    }

    function exportJSON() {
        var data = JSON.stringify({S, P});
        var blob = new Blob([data], {type: "application/json"});
        var a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "workshop_backup.json";
        a.click();
    }

    render();
</script>
</body>
</html>
