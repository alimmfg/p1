<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Tahoma; padding: 10px; direction: rtl; background: #f9f9f9; }
        .box { background: #fff; padding: 15px; border-radius: 10px; border: 2px solid #ddd; }
        input { padding: 12px; width: 60%; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 5px; }
        button { padding: 10px; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; color: #fff; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #444; padding: 10px; text-align: center; vertical-align: top; }
        th { background: #34495e; color: white; font-size: 13px; }
        .p-name { cursor: pointer; color: #2c3e50; font-weight: bold; display: block; margin-bottom: 5px; }
        .done-p { background: #d4edda !important; } 
        .done-s { background: #e3f2fd !important; border: 2px solid #2196f3 !important; } 
        .log-text { text-align: right; font-size: 11px; white-space: pre-wrap; line-height: 1.6; }
        .date-label { color: #d35400; font-weight: bold; font-size: 10px; display: block; border-bottom: 1px dashed #ccc; margin-top: 5px; margin-bottom: 3px; }
        .btn-tiny { font-size: 9px; padding: 4px 6px; color: #fff; border-radius: 4px; margin-top: 5px; }
    </style>
</head>
<body>

<div class="box">
    <div style="margin-bottom: 20px;">
        <input type="text" id="p_in" placeholder="Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯">
        <button onclick="addProject()" style="background:#27ae60">+ Ù¾Ø±ÙˆÚ˜Ù‡</button>
        <br>
        <input type="text" id="s_in" placeholder="Ù†Ø§Ù… Ù…Ø±Ø­Ù„Ù‡ Ø¬Ø¯ÛŒØ¯">
        <button onclick="addStep()" style="background:#2980b9">+ Ù…Ø±Ø­Ù„Ù‡</button>
    </div>

    <div style="overflow-x: auto;">
        <table id="myTable">
            <thead id="h_t"></thead>
            <tbody id="b_t"></tbody>
        </table>
    </div>

    <div style="margin-top:20px; display: flex; gap: 10px;">
        <button onclick="exportData()" style="flex: 1; background:#8e44ad;">ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
        <button onclick="document.getElementById('fileIn').click()" style="flex: 1; background:#d63031;">ğŸ“¥ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</button>
        <input type="file" id="fileIn" style="display:none" onchange="importData(event)">
    </div>
</div>

<script>
    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø­Ø§ÙØ¸Ù‡ Ù†Ø³Ø®Ù‡ 5 Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ¯Ø§Ø®Ù„
    var prjs = JSON.parse(localStorage.getItem('P_DATA_V5')) || [];
    var stps = JSON.parse(localStorage.getItem('S_DATA_V5')) || [];

    function refresh() {
        localStorage.setItem('P_DATA_V5', JSON.stringify(prjs));
        localStorage.setItem('S_DATA_V5', JSON.stringify(stps));

        var h = document.getElementById('h_t');
        var headHtml = '<tr><th>Ù¾Ø±ÙˆÚ˜Ù‡</th>';
        for(var i=0; i<stps.length; i++) {
            headHtml += '<th><span onclick="editS('+i+')">'+stps[i]+'</span><br><small onclick="delS('+i+')" style="color:#ff7675;cursor:pointer;font-size:10px">[Ø­Ø°Ù]</small></th>';
        }
        h.innerHTML = headHtml + '</tr>';

        var b = document.getElementById('b_t');
        var bodyHtml = '';
        for(var j=0; j<prjs.length; j++) {
            var p = prjs[j];
            bodyHtml += '<tr class="'+(p.f?'done-p':'')+'">';
            bodyHtml += '<td><span class="p-name" onclick="editP('+j+')">'+p.n+'</span>' +
                       '<button onclick="toggleP('+j+')" class="btn-tiny" style="background:#636e72">'+(p.f?'Ø¨Ø§Ø²Ú¯Ø´Øª':'Ø§ØªÙ…Ø§Ù… Ú©Ù„')+'</button></td>';
            
            for(var k=0; k<stps.length; k++) {
                var d = p.d[k] || {t:'', f:false};
                var cellClass = d.f ? 'done-s' : '';
                bodyHtml += '<td class="'+cellClass+'" onclick="editCell('+j+','+k+')">' +
                           '<div class="log-text">' + (d.t || '---') + '</div>' +
                           '<div style="margin-top:5px"><button onclick="event.stopPropagation(); toggleStep('+j+','+k+')" class="btn-tiny" style="background:#0984e3">'+(d.f?'â†©':'âœ… Ø§ØªÙ…Ø§Ù…')+'</button></div>' +
                           '</td>';
            }
            bodyHtml += '</tr>';
        }
        b.innerHTML = bodyHtml;
    }

    function addProject() {
        var v = document.getElementById('p_in').value;
        if(v) {
            prjs.push({n:v, d:{}, f:false});
            document.getElementById('p_in').value='';
            refresh();
        }
    }

    function addStep() {
        var v = document.getElementById('s_in').value;
        if(v) {
            stps.push(v);
            document.getElementById('s_in').value='';
            refresh();
        }
    }

    function editCell(pi, si) {
        if(!prjs[pi].d[si]) prjs[pi].d[si] = {t:'', f:false};
        var txt = prompt("Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯:");
        if(txt) {
            var now = new Date();
            var time = now.getHours() + ":" + (now.getMinutes()<10?'0':'') + now.getMinutes();
            var date = now.toLocaleDateString('fa-IR');
            var newEntry = '<span class="date-label">' + date + ' - ' + time + '</span>' + txt;
            prjs[pi].d[si].t = newEntry + "<br>" + prjs[pi].d[si].t;
            refresh();
        }
    }

    function toggleStep(pi, si) {
        if(!prjs[pi].d[si]) prjs[pi].d[si] = {t:'', f:false};
        prjs[pi].d[si].f = !prjs[pi].d[si].f;
        refresh();
    }

    function editP(i) { var n = prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ù¾Ø±ÙˆÚ˜Ù‡:", prjs[i].n); if(n) { prjs[i].n = n; refresh(); } }
    function editS(i) { var n = prompt("Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ù…Ø±Ø­Ù„Ù‡:", stps[i]); if(n) { stps[i] = n; refresh(); } }
    function toggleP(i) { prjs[i].f = !prjs[i].f; refresh(); }
    function delS(i) { if(confirm('Ø­Ø°Ù Ù…Ø±Ø­Ù„Ù‡ØŸ')) { stps.splice(i,1); refresh(); } }

    function exportData() {
        var blob = new Blob([JSON.stringify({prjs, stps})], {type: 'application/json'});
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "workshop_backup.json"; a.click();
    }

    function importData(event) {
        var reader = new FileReader();
        reader.onload = function(e) {
            var data = JSON.parse(e.target.result);
            prjs = data.prjs; stps = data.stps; refresh();
            alert("Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯.");
        };
        reader.readAsText(event.target.files[0]);
    }

    refresh();
</script>
</body>
</html>
