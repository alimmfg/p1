<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>مدیریت پروژه</title>
<style>
body{font-family:Tahoma;background:#f4f4f4;margin:0;padding:10px}
.project{background:#fff;border-radius:10px;padding:10px;margin-bottom:10px}
.project-title{font-weight:bold;font-size:18px;cursor:pointer}
.step{margin-top:8px;padding:6px;border:1px solid #ddd;border-radius:6px}
.step-title{font-weight:bold;cursor:pointer}
.log{background:#eee;padding:6px;border-radius:6px;margin-top:5px;cursor:pointer}
.done{opacity:.5;text-decoration:line-through}
button{margin-top:5px}
</style>
</head>

<body>

<button onclick="newProject()">➕ پروژه جدید</button>
<div id="app"></div>

<!-- مودال یادداشت -->
<div id="logModal" style="
display:none;
position:fixed;
top:0;left:0;
width:100%;height:100%;
background:rgba(0,0,0,0.5);
z-index:999;
align-items:center;
justify-content:center;
">
<div style="background:white;padding:15px;border-radius:10px;width:90%;max-width:400px;">
<h4>یادداشت</h4>
<textarea id="logText" rows="6" style="width:100%;font-family:Tahoma"></textarea>
<br><br>
<button onclick="saveLog()">ثبت</button>
<button onclick="closeLog()">انصراف</button>
</div>
</div>

<script>
var prjs = [];
var curP=null, curS=null, curL=null;
var app = document.getElementById("app");
var logModal=document.getElementById("logModal");
var logText=document.getElementById("logText");

function newProject(){
    var n = prompt("نام پروژه:");
    if(!n) return;
    prjs.push({n:n,s:[],f:false,c:{}});
    refresh();
}

function refresh(){
    app.innerHTML="";
    prjs.forEach((p,pi)=>{
        var d=document.createElement("div");
        d.className="project"+(p.f?" done":"");
        d.innerHTML=`
        <div class="project-title" onclick="editProject(${pi})">${p.n}</div>
        <button onclick="newStep(${pi})">➕ مرحله</button>
        <button onclick="finishProject(${pi})">اتمام پروژه</button>
        `;
        p.s.forEach((s,si)=>{
            var sd=document.createElement("div");
            sd.className="step"+(p.c[si]?.f?" done":"");
            sd.innerHTML=`
            <div class="step-title" onclick="editStep(${pi},${si})">${s}</div>
            <button onclick="addLog(${pi},${si})">یادداشت</button>
            <button onclick="finishStep(${pi},${si})">اتمام مرحله</button>
            `;
            (p.c[si]?.logs||[]).forEach((l,li)=>{
                var lg=document.createElement("div");
                lg.className="log";
                lg.innerHTML=l.t.replace(/\n/g,"<br>");
                lg.onclick=()=>editLog(pi,si,li);
                sd.appendChild(lg);
            });
            d.appendChild(sd);
        });
        app.appendChild(d);
    });
}

function editProject(pi){
    var n=prompt("نام پروژه:",prjs[pi].n);
    if(n) prjs[pi].n=n;
    refresh();
}

function editStep(pi,si){
    var n=prompt("نام مرحله:",prjs[pi].s[si]);
    if(n) prjs[pi].s[si]=n;
    refresh();
}

function newStep(pi){
    var n=prompt("نام مرحله:");
    if(!n) return;
    prjs[pi].s.push(n);
    refresh();
}

function finishProject(pi){
    prjs[pi].f=true;
    refresh();
}

function finishStep(pi,si){
    if(!prjs[pi].c[si]) prjs[pi].c[si]={logs:[],f:false};
    prjs[pi].c[si].f=true;
    refresh();
}

function addLog(pi,si){
    curP=pi;curS=si;curL=null;
    logText.value="";
    logModal.style.display="flex";
    logText.focus();
}

function editLog(pi,si,li){
    curP=pi;curS=si;curL=li;
    logText.value=prjs[pi].c[si].logs[li].t;
    logModal.style.display="flex";
    logText.focus();
}

function saveLog(){
    var t=logText.value;
    if(!t.trim()) return;
    if(!prjs[curP].c[curS])
        prjs[curP].c[curS]={logs:[],f:false};
    if(curL!=null){
        prjs[curP].c[curS].logs[curL].t=t;
    }else{
        prjs[curP].c[curS].logs.unshift({t:t});
    }
    closeLog();
    refresh();
}

function closeLog(){
    logModal.style.display="none";
}
</script>
</body>
</html>
